<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>EL Vigía TV</title>
		<link rel="stylesheet" href="themes/vigia.min.css" />
        <link rel="stylesheet" href="css/estilos.css" />
		<link rel="stylesheet" href="css/themes/default/jquery.mobile.structure-1.3.1.min.css" />
		<script src="js/jquery.js"></script>
		<script src="js/jquery.mobile-1.3.1.min.js"></script>
        <script>
            $(document).ready(function () {
              if(GetURLParameter("cat") == false){
                   cargarIndex();
               } else {
                   cargarCategoria(GetURLParameter("cat"));
               }
            });
            function cargarIndex()
            {
                urljson = "http://www.elvigiatv.es/api/get_recent_posts/?dev=1";
                $.ajax({
                       type: "GET",
                       url: urljson,
                       dataType: "json",
                       success: function(resp){
                       // we have the response
                       mostrarRespuestaPosts(resp);
                       },
                       error: function(e){
                       alert('Error121212: ' + e);
                       }
                       });
                $.ajax({
                       type: "GET",
                       url: "http://www.elvigiatv.es/api/get_category_index/?dev=1",
                       dataType: "json",
                       success: function(resp){
                       mostrarRespuestaCategorias(resp);
                       },
                       error: function(e){
                       alert('Error121212: ' + e);
                       }  
                       });
            }
            function GetURLParameter(sParam)
            {
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++)
                {
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] == sParam)
                    {
                        return sParameterName[1];
                    }
                }
                return false;
            }
            function cargarCategoria(catId){
                var parametro = GetURLParameter("cat");
                if(parametro != false){
                    urljson = "http://www.elvigiatv.es/api/get_category_posts/?id="+parametro+"&count=10000";
                }
                $.ajax({
                       type: "GET",
                       url: urljson,
                       dataType: "json",
                       success: function(resp){
                            mostrarRespuestaPosts(resp);
                       },
                       error: function(e){
                            alert('Error121212: ' + e);
                       }
                       });
            }
            function mostrarRespuestaPosts(respuesta) {
                var contenido = '<div data-role="page" data-theme="a"><div data-role="panel" id="mypanel" data-position-fixed="true"><ul data-role="listview" data-theme="b" data-divider-theme="b" data-icon="false" data-global-nav="demos" class="jqm-list ui-listview" id="listacategorias"><li data-role="list-divider" role="heading" class="ui-li ui-li-divider ui-bar-d ui-first-child">Categorías</li>                </ul></div><div data-role="header" data-position="fixed" data-tap-toggle="false"><a href="#mypanel" data-rel="open" data-role="button">Menú</a><h1>El Vigía TV</h1></div><div data-role="content" data-theme="b" id="contenedor"></div></div>';
                $("body").append(contenido);
                contenido = '';
                for(var i=0; i<respuesta.count; i++) {
                    var post = respuesta.posts[i];
                    contenido = contenido + '<article><div class="cuadrado"><br><div class="media"><img src='+getImagen(post)+' class="imagen"/></div><p id="titulo">'+post.title+'</p><div data-role="collapsible-set" data-inset="false"><div data-role="collapsible"><h3>Más info...</h3><p>'+post.content+'</p></div><div data-role="collapsible"><h3>Programa</h3><a href="#" data-role="button" data-inline="true">Ver vídeo</a></div></div></div></article>';
                }
                $("#contenedor").empty().append(contenido);                
                $("body").html().trigger("create");
                /*$("div").trigger( "create" );
                $("article div p").addClass("texto-titulo");
                $("div[data-role='collapsible'] p").removeClass("texto-titulo");
                $("div[data-role='collapsible'] p").addClass("parrafo");*/
            }
            function getImagen(post) {
                var video = post.video;
                var campos = video.split('/');
                var videoId = campos[campos.length -1];
                return "http://www.elvigiatv.es/images/thumbnails/"+videoId+"s.jpg";
            }
            function mostrarRespuestaCategorias(respuesta) {
                var contenido = '';
                for(var i=0; i<respuesta.count;i++) {
                    var categoria = respuesta.categories[i];
                    contenido = contenido +'<li><a href="" onClick="verCategoria('+categoria.id+');" data-transition="slide">'+categoria.title+'</a></li>';
                }
                $("#listacategorias").append(contenido);
                $("#listacategorias").listview( "refresh" );
            }
            function verCategoria(cat){
                $.mobile.changePage( "index.html?cat="+cat, {
                                transition: "slide",
                                reverse: false,
                                changeHash: false,
                                reloadPage: true
                });
            }
            
        </script>
	</head>
	<body>
		
	</body>